<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Engagement Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e3e9;
        }
        .container {
            max-width: 900px;
        }
        .report-card, .admin-card {
            background-color: rgb(231, 190, 190);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .status-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1s linear infinite;
            animation: spinner 1s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for analytics section */
        .analytics-table::-webkit-scrollbar {
            width: 8px;
        }
        .analytics-table::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .analytics-table::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .analytics-table::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Container -->
    <div id="app" class="container mx-auto p-4 flex flex-col items-center">
        <!-- Header -->
        <header class="w-full text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Civic Engagement Platform</h1>
            <p class="text-gray-500 mt-2">Report issues, track progress, and build a better community.</p>
            <div id="auth-info" class="text-xs text-gray-400 mt-2"></div>
        </header>

        <!-- View Switcher & Loading -->
        <div class="w-full max-w-lg flex justify-center mb-6">
            <button id="toggleViewBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-300">
                Switch to Admin View
            </button>
        </div>
        <div id="loading" class="hidden flex items-center justify-center p-8">
            <div class="loading-spinner w-8 h-8 border-4 rounded-full border-gray-200"></div>
            <span class="ml-4 text-gray-500">Loading...</span>
        </div>

        <!-- Citizen View -->
        <div id="citizenView" class="w-full max-w-lg">
            <!-- Report Button -->
            <button id="openReportFormBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i> Report a New Issue
            </button>

            <!-- User Reports List -->
            <div id="userReports" class="mt-8 space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">My Reports</h2>
                <div id="reportsList" class="space-y-4">
                    <!-- Reports will be dynamically injected here -->
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="w-full hidden">
            <!-- Analytics Section -->
            <div class="admin-card p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Platform Analytics</h2>
                <div id="analytics" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4 text-center">
                    <div class="p-4 bg-blue-50 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Total Reports</p>
                        <p id="totalReports" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Resolved</p>
                        <p id="resolvedReports" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-xl shadow-sm">
                        <p class="text-gray-500 text-sm">Average Resolution Time</p>
                        <p id="avgResolutionTime" class="text-2xl font-bold text-yellow-600">--</p>
                    </div>
                </div>

                <div class="overflow-x-auto analytics-table">
                    <h3 class="font-medium text-gray-700 mb-2">Reports by Category</h3>
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 text-left text-sm font-medium text-gray-600">Category</th>
                                <th class="py-2 px-4 text-left text-sm font-medium text-gray-600">Count</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTable">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Filters -->
            <div class="admin-card p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Manage All Issues</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <select id="filterCategory" class="w-full sm:w-1/3 p-2 border border-gray-300 rounded-lg">
                        <option value="all">All Categories</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Graffiti">Graffiti</option>
                        <option value="Streetlight">Streetlight</option>
                        <option value="Waste">Waste Management</option>
                        <option value="Park">Park Maintenance</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="filterStatus" class="w-full sm:w-1/3 p-2 border border-gray-300 rounded-lg">
                        <option value="all">All Statuses</option>
                        <option value="Reported">Reported</option>
                        <option value="Acknowledged">Acknowledged</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                    <input type="text" id="filterLocation" placeholder="Filter by Location" class="w-full sm:w-1/3 p-2 border border-gray-300 rounded-lg">
                </div>
                <div id="adminReports" class="space-y-4">
                    <!-- Admin Reports List -->
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm transform transition-all duration-300 scale-95 opacity-0" id="adminLoginContainer">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Login</h2>
            <p class="text-gray-500 mb-4">Enter the Admin User ID to access the administrative section.</p>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label for="adminId" class="block text-gray-700 font-medium mb-1">Admin User ID</label>
                    <input type="text" id="adminId" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <p id="loginError" class="text-sm text-red-500 hidden">Incorrect User ID. Please try again.</p>
                <div class="flex justify-end gap-2">
                    <button type="button" id="closeAdminLoginBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all duration-300">Cancel</button>
                    <button type="submit" id="submitAdminLoginBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">Login</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Form Modal -->
    <div id="reportFormModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Added max-h-5/6 and overflow-y-auto to allow scrolling for the entire form on smaller screens -->
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0 max-h-5/6 overflow-y-auto" id="reportFormContainer">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Report an Issue</h2>
            <form id="reportForm" class="space-y-4">
                <div>
                    <label for="reportTitle" class="block text-gray-700 font-medium mb-1">Title</label>
                    <input type="text" id="reportTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="reportDescription" class="block text-gray-700 font-medium mb-1">Description</label>
                    <textarea id="reportDescription" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 max-h-40 overflow-y-auto"></textarea>
                </div>
                <div>
                    <label for="reportCategory" class="block text-gray-700 font-medium mb-1">Category</label>
                    <select id="reportCategory" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a category</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Graffiti">Graffiti</option>
                        <option value="Streetlight">Broken Streetlight</option>
                        <option value="Waste">Waste Management</option>
                        <option value="Park">Park Maintenance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="reportLocation" class="block text-gray-700 font-medium mb-1">Location</label>
                    <div class="relative">
                        <input type="text" id="reportLocation" required class="w-full p-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter landmark, address, or pin code">
                        <button type="button" id="searchLocationBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full transition-colors duration-200">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="location-results" class="hidden text-sm text-gray-600 p-2 border border-dashed border-gray-300 rounded-lg">
                    <p>Searching for location...</p>
                </div>
                <!-- New media upload fields -->
                <div>
                    <label for="reportPhoto" class="block text-gray-700 font-medium mb-1">Upload Photos</label>
                    <input type="file" id="reportPhoto" accept="image/*" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="reportVideo" class="block text-gray-700 font-medium mb-1">Upload Video</label>
                    <input type="file" id="reportVideo" accept="video/*" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="reportAudio" class="block text-gray-700 font-medium mb-1">Upload Voice Note</label>
                    <input type="file" id="reportAudio" accept="audio/*" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex flex-col sm:flex-row justify-between gap-2">
                    <button type="button" id="closeReportFormBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all duration-300">Cancel</button>
                    <button type="submit" id="submitReportBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">Submit Report</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Report Modal -->
    <div id="adminReportModal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="adminReportContainer">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <div id="modalContent" class="space-y-4">
                <div id="modalMedia" class="space-y-4">
                    <!-- Media will be injected here -->
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Status</p>
                    <select id="modalStatus" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Reported">Reported</option>
                        <option value="Acknowledged">Acknowledged</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Assigned To</p>
                    <input type="text" id="modalAssignedTo" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <p class="text-gray-500 text-sm">Notes</p>
                    <div id="notesDisplay" class="bg-gray-100 p-3 rounded-lg max-h-40 overflow-y-auto mb-2"></div>
                    <textarea id="modalNewNote" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add a new note..."></textarea>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row justify-between gap-2 mt-4">
                <button type="button" id="closeAdminModalBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all duration-300">Close</button>
                <button type="button" id="saveAdminChangesBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, setDoc, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Use the provided global variables for Firebase configuration
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
       // Replace this with your actual Firebase config from your console
const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "your-project-id.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project-id.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // State variables
        let reports = [];
        let userId = null;
        let isAdminView = false;
        let currentFilters = { category: 'all', status: 'all', location: '' };
        // Admin user ID for demo purposes. In a real app, this would be more secure.
        const ADMIN_USER_ID = 'admin';

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const citizenViewEl = document.getElementById('citizenView');
        const adminViewEl = document.getElementById('adminView');
        const reportsListEl = document.getElementById('reportsList');
        const adminReportsEl = document.getElementById('adminReports');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const authInfoEl = document.getElementById('auth-info');

        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginContainer = document.getElementById('adminLoginContainer');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminIdInput = document.getElementById('adminId');
        const loginErrorEl = document.getElementById('loginError');
        const closeAdminLoginBtn = document.getElementById('closeAdminLoginBtn');

        const reportFormModal = document.getElementById('reportFormModal');
        const reportFormContainer = document.getElementById('reportFormContainer');
        const openReportFormBtn = document.getElementById('openReportFormBtn');
        const closeReportFormBtn = document.getElementById('closeReportFormBtn');
        const reportForm = document.getElementById('reportForm');
        const submitReportBtn = document.getElementById('submitReportBtn');

        const adminReportModal = document.getElementById('adminReportModal');
        const adminReportContainer = document.getElementById('adminReportContainer');
        const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');
        const saveAdminChangesBtn = document.getElementById('saveAdminChangesBtn');
        const modalMediaEl = document.getElementById('modalMedia');

        const filterCategoryEl = document.getElementById('filterCategory');
        const filterStatusEl = document.getElementById('filterStatus');
        const filterLocationEl = document.getElementById('filterLocation');

        const totalReportsEl = document.getElementById('totalReports');
        const resolvedReportsEl = document.getElementById('resolvedReports');
        const avgResolutionTimeEl = document.getElementById('avgResolutionTime');
        const categoryTableEl = document.getElementById('categoryTable');

        // New Location elements
        const searchLocationBtn = document.getElementById('searchLocationBtn');
        const locationResultsEl = document.getElementById('location-results');

        // Initial Authentication
        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }
                console.log("Signed in with user ID:", userId);
                authInfoEl.textContent = `You are user: ${userId}`;
                startRealtimeListeners();
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }

        // Real-time listeners
        function startRealtimeListeners() {
            const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);

            onSnapshot(reportsCollectionRef, (snapshot) => {
                loadingEl.classList.add('hidden');
                reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
                renderAnalytics();
            }, (error) => {
                console.error("Error listening to reports:", error);
                loadingEl.innerHTML = `<span class="text-red-500">Error loading data. Please try again.</span>`;
            });
        }

        // Render UI based on current view and data
        function renderUI() {
            if (isAdminView) {
                renderAdminView();
            } else {
                renderCitizenView();
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Reported': return 'bg-gray-200 text-gray-800';
                case 'Acknowledged': return 'bg-blue-200 text-blue-800';
                case 'In Progress': return 'bg-yellow-200 text-yellow-800';
                case 'Resolved': return 'bg-green-200 text-green-800';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        function renderCitizenView() {
            citizenViewEl.classList.remove('hidden');
            adminViewEl.classList.add('hidden');
            toggleViewBtn.textContent = 'Switch to Admin View';

            // Filter reports to only show the current user's reports
            const userReports = reports.filter(report => report.userId === userId);
            reportsListEl.innerHTML = userReports.length > 0 ? '' : '<p class="text-center text-gray-500">No reports submitted yet.</p>';

            userReports.forEach(report => {
                const reportCard = `
                    <div class="report-card p-4 sm:p-6 mb-4 flex flex-col sm:flex-row items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-bold text-gray-800 truncate">${report.title}</h3>
                            <p class="text-gray-500 text-sm mt-1 mb-2">${report.description}</p>
                            <span class="status-pill ${getStatusColor(report.status)}">${report.status}</span>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-4 text-sm text-gray-500 flex-shrink-0">
                            <p><strong>Category:</strong> ${report.category}</p>
                            <p><strong>Location:</strong> ${report.location}</p>
                            <p><strong>Reported by:</strong> ${report.userId.substring(0, 8)}...</p>
                        </div>
                    </div>
                `;
                reportsListEl.innerHTML += reportCard;
            });
        }

        function renderAdminView() {
            citizenViewEl.classList.add('hidden');
            adminViewEl.classList.remove('hidden');
            toggleViewBtn.textContent = 'Switch to Citizen View';

            const filteredReports = reports.filter(report => {
                const categoryMatch = currentFilters.category === 'all' || report.category === currentFilters.category;
                const statusMatch = currentFilters.status === 'all' || report.status === currentFilters.status;
                const locationMatch = currentFilters.location === '' || report.location.toLowerCase().includes(currentFilters.location.toLowerCase());
                return categoryMatch && statusMatch && locationMatch;
            });

            adminReportsEl.innerHTML = filteredReports.length > 0 ? '' : '<p class="text-center text-gray-500">No reports match the filters.</p>';

            filteredReports.forEach(report => {
                const reportCard = `
                    <div class="admin-card p-4 sm:p-6 flex flex-col sm:flex-row items-start justify-between cursor-pointer" data-id="${report.id}">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-bold text-gray-800 truncate">${report.title}</h3>
                            <p class="text-gray-500 text-sm mt-1 mb-2">
                                <span class="status-pill ${getStatusColor(report.status)}">${report.status}</span>
                                ${report.assignedTo ? `<span class="ml-2">Assigned to: ${report.assignedTo}</span>` : ''}
                            </p>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-4 text-sm text-gray-500 flex-shrink-0">
                            <p><strong>Category:</strong> ${report.category}</p>
                            <p><strong>Location:</strong> ${report.location}</p>
                        </div>
                    </div>
                `;
                adminReportsEl.innerHTML += reportCard;
            });
            
            // Add click listeners to the new admin cards
            document.querySelectorAll('.admin-card').forEach(card => {
                card.addEventListener('click', () => {
                    const reportId = card.dataset.id;
                    const report = reports.find(r => r.id === reportId);
                    if (report) {
                        openAdminModal(report);
                    }
                });
            });
        }

        // Render Analytics
        function renderAnalytics() {
            const resolvedCount = reports.filter(r => r.status === 'Resolved').length;
            const avgTime = calculateAvgResolutionTime();
            const categoryCounts = calculateCategoryCounts();

            totalReportsEl.textContent = reports.length;
            resolvedReportsEl.textContent = resolvedCount;
            avgResolutionTimeEl.textContent = avgTime !== 'N/A' ? `${avgTime} days` : '--';

            categoryTableEl.innerHTML = '';
            const sortedCategories = Object.entries(categoryCounts).sort((a, b) => b[1] - a[1]);
            sortedCategories.forEach(([category, count]) => {
                categoryTableEl.innerHTML += `
                    <tr>
                        <td class="py-2 px-4 text-gray-800">${category}</td>
                        <td class="py-2 px-4 text-gray-800">${count}</td>
                    </tr>
                `;
            });
        }
        
        function calculateAvgResolutionTime() {
            const resolvedReports = reports.filter(r => r.status === 'Resolved' && r.timestamp && r.resolvedTimestamp);
            if (resolvedReports.length === 0) return 'N/A';

            const totalTime = resolvedReports.reduce((sum, report) => {
                const start = report.timestamp.toDate().getTime();
                const end = report.resolvedTimestamp.toDate().getTime();
                return sum + (end - start);
            }, 0);

            const avgTimeMs = totalTime / resolvedReports.length;
            const days = Math.round(avgTimeMs / (1000 * 60 * 60 * 24));
            return days;
        }
        
        function calculateCategoryCounts() {
            return reports.reduce((acc, report) => {
                acc[report.category] = (acc[report.category] || 0) + 1;
                return acc;
            }, {});
        }

        // Event Listeners
        toggleViewBtn.addEventListener('click', () => {
            if (isAdminView) {
                isAdminView = false;
                renderUI();
            } else {
                openAdminLoginModal();
            }
        });

        // Admin Login Modal
        function openAdminLoginModal() {
            adminLoginModal.classList.remove('hidden');
            setTimeout(() => {
                adminLoginContainer.classList.remove('scale-95', 'opacity-0');
                adminLoginContainer.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        closeAdminLoginBtn.addEventListener('click', () => {
            adminLoginContainer.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                adminLoginModal.classList.add('hidden');
            }, 300);
            adminLoginForm.reset();
            loginErrorEl.classList.add('hidden');
        });

        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredId = adminIdInput.value.trim();
            if (enteredId === ADMIN_USER_ID) {
                isAdminView = true;
                renderUI();
                closeAdminLoginBtn.click();
            } else {
                loginErrorEl.classList.remove('hidden');
            }
        });

        // Report Form Modal
        openReportFormBtn.addEventListener('click', () => {
            reportFormModal.classList.remove('hidden');
            setTimeout(() => {
                reportFormContainer.classList.remove('scale-95', 'opacity-0');
                reportFormContainer.classList.add('scale-100', 'opacity-100');
            }, 10);
        });

        closeReportFormBtn.addEventListener('click', () => {
            reportFormContainer.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                reportFormModal.classList.add('hidden');
                reportForm.reset();
            }, 300);
        });

        // Simulating Geocoding and Location Search
        searchLocationBtn.addEventListener('click', () => {
            const query = reportForm.reportLocation.value.trim();
            if (query === '') {
                locationResultsEl.classList.add('hidden');
                return;
            }
            
            // In a real application, you would make an API call to a geocoding service here.
            // For example, using Google Maps Geocoding API, OpenStreetMap, or another service.
            // const geocodingApiUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query)}&key=YOUR_API_KEY`;
            
            // Here we're just simulating a result.
            locationResultsEl.classList.remove('hidden');
            locationResultsEl.innerHTML = `<p class="font-bold">Searching for "${query}"...</p>`;
            
            setTimeout(() => {
                locationResultsEl.innerHTML = `
                    <p class="font-bold">Location found:</p>
                    <p class="text-gray-500">${query}, Simulated City, ST 12345</p>
                    <p class="mt-2 text-xs text-gray-400">This is a simulated result. A live API would return real location data.</p>
                `;
            }, 1500);
        });

        /*
         * The 'storage/unauthorized' error indicates a Firebase Storage permissions issue.
         * To fix this, you must configure your Firebase Storage Security Rules to allow
         * authenticated users to upload files.
         *
         * Paste the following rules into your Firebase Storage console:
         *
         * service firebase.storage {
         * match /b/{bucket}/o {
         * match /artifacts/{appId}/reports/{userId}/{allPaths=**} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         * }
         * }
         */
        async function uploadMedia(file) {
            const fileRef = ref(storage, `artifacts/${appId}/reports/${userId}/${Date.now()}_${file.name}`);
            try {
                const uploadTask = await uploadBytes(fileRef, file);
                const url = await getDownloadURL(uploadTask.ref);
                return { url, type: file.type };
            } catch (error) {
                console.error("Error uploading file:", error);
                return null;
            }
        }

        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitReportBtn.disabled = true;
            submitReportBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...`;

            const title = reportForm.reportTitle.value;
            const description = reportForm.reportDescription.value;
            const category = reportForm.reportCategory.value;
            const location = reportForm.reportLocation.value;
            
            const reportsCollectionRef = collection(db, `artifacts/${appId}/public/data/reports`);

            // Get selected files from the form
            const photoFile = document.getElementById('reportPhoto').files[0];
            const videoFile = document.getElementById('reportVideo').files[0];
            const audioFile = document.getElementById('reportAudio').files[0];
            
            const mediaUploads = [];
            if (photoFile) mediaUploads.push(uploadMedia(photoFile));
            if (videoFile) mediaUploads.push(uploadMedia(videoFile));
            if (audioFile) mediaUploads.push(uploadMedia(audioFile));

            const mediaUrls = (await Promise.all(mediaUploads)).filter(item => item !== null);

            // Automated Routing Engine simulation
            let assignedTo = "Unassigned";
            switch (category) {
                case "Pothole":
                case "Streetlight":
                    assignedTo = "Public Works Department";
                    break;
                case "Graffiti":
                    assignedTo = "Sanitation Department";
                    break;
                case "Park":
                    assignedTo = "Parks & Recreation";
                    break;
                case "Waste":
                    assignedTo = "Waste Management";
                    break;
                default:
                    assignedTo = "General Services";
                    break;
            }

            const newReport = {
                userId,
                title,
                description,
                category,
                location,
                status: 'Reported',
                assignedTo,
                timestamp: Timestamp.now(),
                notes: [{ text: "Report submitted.", timestamp: Timestamp.now() }],
                media: mediaUrls
            };

            try {
                await addDoc(reportsCollectionRef, newReport);
                console.log("Report submitted successfully.");
                closeReportFormBtn.click();
            } catch (error) {
                console.error("Error submitting report:", error);
            } finally {
                submitReportBtn.disabled = false;
                submitReportBtn.innerHTML = `Submit Report`;
            }
        });
        
        // Admin Modal
        let currentReportId = null;

        function openAdminModal(report) {
            currentReportId = report.id;
            document.getElementById('modalTitle').textContent = report.title;
            document.getElementById('modalStatus').value = report.status;
            document.getElementById('modalAssignedTo').value = report.assignedTo || '';
            
            const notesDisplay = document.getElementById('notesDisplay');
            notesDisplay.innerHTML = '';
            if (report.notes) {
                report.notes.forEach(note => {
                    notesDisplay.innerHTML += `<p class="text-sm text-gray-700">${note.text} <span class="text-gray-400 text-xs">(${note.timestamp.toDate().toLocaleString()})</span></p>`;
                });
                notesDisplay.scrollTop = notesDisplay.scrollHeight;
            }

            // Display uploaded media
            modalMediaEl.innerHTML = '';
            if (report.media && report.media.length > 0) {
                modalMediaEl.innerHTML += `<h3 class="font-medium text-gray-700 mb-2">Attached Media</h3>`;
                report.media.forEach(media => {
                    if (media.type.startsWith('image')) {
                        modalMediaEl.innerHTML += `<img src="${media.url}" alt="Report Photo" class="w-full rounded-lg shadow-md mt-2">`;
                    } else if (media.type.startsWith('video')) {
                        modalMediaEl.innerHTML += `<video controls src="${media.url}" class="w-full rounded-lg shadow-md mt-2"></video>`;
                    } else if (media.type.startsWith('audio')) {
                        modalMediaEl.innerHTML += `<audio controls src="${media.url}" class="w-full mt-2"></audio>`;
                    }
                });
            }

            adminReportModal.classList.remove('hidden');
            setTimeout(() => {
                adminReportContainer.classList.remove('scale-95', 'opacity-0');
                adminReportContainer.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        closeAdminModalBtn.addEventListener('click', () => {
            adminReportContainer.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                adminReportModal.classList.add('hidden');
            }, 300);
        });

        saveAdminChangesBtn.addEventListener('click', async () => {
            if (!currentReportId) return;
            const reportRef = doc(db, `artifacts/${appId}/public/data/reports`, currentReportId);
            
            const newStatus = document.getElementById('modalStatus').value;
            const newAssignedTo = document.getElementById('modalAssignedTo').value;
            const newNoteText = document.getElementById('modalNewNote').value;
            
            const currentReport = reports.find(r => r.id === currentReportId);
            const updatedData = {
                status: newStatus,
                assignedTo: newAssignedTo
            };

            // Handle notes update
            if (newNoteText.trim() !== '') {
                const newNote = { text: newNoteText, timestamp: Timestamp.now() };
                const existingNotes = Array.isArray(currentReport.notes) ? currentReport.notes : [];
                updatedData.notes = [...existingNotes, newNote];
            }

            // Handle resolution time
            if (newStatus === 'Resolved' && currentReport.status !== 'Resolved') {
                updatedData.resolvedTimestamp = Timestamp.now();
            }

            try {
                await updateDoc(reportRef, updatedData);
                console.log("Report updated successfully.");
                document.getElementById('modalNewNote').value = '';
                closeAdminModalBtn.click();
            } catch (error) {
                console.error("Error updating report:", error);
            }
        });

        // Filter event listeners
        filterCategoryEl.addEventListener('change', (e) => {
            currentFilters.category = e.target.value;
            renderAdminView();
        });
        filterStatusEl.addEventListener('change', (e) => {
            currentFilters.status = e.target.value;
            renderAdminView();
        });
        filterLocationEl.addEventListener('input', (e) => {
            currentFilters.location = e.target.value;
            renderAdminView();
        });

        // Start the application
        window.onload = signIn;

    </script>
</body>
</html>
